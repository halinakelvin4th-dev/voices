<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Creator Studio - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #10b981; margin-top: -6px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }
        audio { filter: invert(1) hue-rotate(180deg); opacity: 0.9; border-radius: 0.5rem; }
        .glass-panel { background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        @keyframes bounce-in { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .notification-pop { animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="bg-[#0B1120] text-white font-sans h-screen flex flex-col overflow-hidden">

    <!-- LOGIN VIEW -->
    <div id="auth-view" class="absolute inset-0 z-50 flex items-center justify-center bg-[#0B1120]">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md shadow-2xl relative overflow-hidden">
            <div id="login-form-container">
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold text-white">AI Studio Login</h1>
                    <p class="text-slate-400 text-sm mt-1">Connected to Database</p>
                </div>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <input type="text" id="login-user" class="w-full bg-[#0f172a] border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-emerald-500 outline-none" placeholder="Username">
                    <input type="password" id="login-pass" class="w-full bg-[#0f172a] border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-emerald-500 outline-none" placeholder="Password">
                    <button type="submit" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg">Login</button>
                </form>
                <p class="text-center text-xs text-slate-500 mt-4">New? <button onclick="toggleAuthMode('signup')" class="text-emerald-400 font-bold">Create Account</button></p>
            </div>
            <div id="signup-form-container" class="hidden">
                <div class="text-center mb-8"><h1 class="text-2xl font-bold text-white">Join Studio</h1></div>
                <form onsubmit="handleSignup(event)" class="space-y-4">
                    <input type="email" id="signup-email" required class="w-full bg-[#0f172a] border border-slate-700 rounded-xl px-4 py-3 text-white" placeholder="Email">
                    <input type="text" id="signup-user" required class="w-full bg-[#0f172a] border border-slate-700 rounded-xl px-4 py-3 text-white" placeholder="Username">
                    <input type="password" id="signup-pass" required class="w-full bg-[#0f172a] border border-slate-700 rounded-xl px-4 py-3 text-white" placeholder="Password">
                    <button type="submit" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg">Sign Up</button>
                </form>
                <p class="text-center text-xs text-slate-500 mt-4">Has account? <button onclick="toggleAuthMode('login')" class="text-emerald-400 font-bold">Login</button></p>
            </div>
            <p id="auth-error" class="text-red-400 text-xs text-center mt-4 hidden bg-red-500/10 p-2 rounded"></p>
        </div>
    </div>

    <!-- ADMIN VIEW -->
    <div id="admin-view" class="absolute inset-0 z-40 bg-[#0B1120] hidden flex flex-col">
        <div class="border-b border-slate-800 bg-[#0f172a] px-6 py-4 flex justify-between items-center shadow-md">
            <h2 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="zap" class="w-5 h-5 text-emerald-500"></i> Live Dashboard</h2>
            <div class="flex gap-3">
                <button onclick="goToToolAsAdmin()" class="px-4 py-2 bg-indigo-600 text-white text-xs font-bold rounded-lg flex gap-2">Open Generator</button>
                <button onclick="logout()" class="px-4 py-2 bg-slate-800 text-red-400 text-xs font-bold rounded-lg border border-slate-700">Logout</button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-6 max-w-7xl mx-auto w-full space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="glass-panel p-6 rounded-2xl border-l-4 border-indigo-500">
                    <p class="text-slate-400 text-xs uppercase font-bold">Total Users</p>
                    <h3 class="text-3xl font-bold text-white mt-1" id="admin-total-users">...</h3>
                </div>
                <div class="glass-panel p-6 rounded-2xl border-l-4 border-emerald-500">
                    <p class="text-slate-400 text-xs uppercase font-bold">Revenue</p>
                    <h3 class="text-3xl font-bold text-white mt-1">$<span id="admin-revenue">...</span></h3>
                </div>
                <div class="glass-panel p-6 rounded-2xl border-l-4 border-amber-500 relative">
                    <p class="text-slate-400 text-xs uppercase font-bold">Pending Requests</p>
                    <h3 class="text-3xl font-bold text-white mt-1" id="admin-pending-count">...</h3>
                    <span class="absolute top-4 right-4 h-4 w-4 bg-red-500 rounded-full animate-pulse hidden" id="admin-notification-dot"></span>
                </div>
            </div>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="glass-panel p-6 rounded-2xl h-[400px] flex flex-col">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">Live Requests <span class="text-xs bg-red-500/20 text-red-400 px-2 rounded animate-pulse">Real-time</span></h3>
                    <div id="requests-list" class="space-y-3 flex-1 overflow-y-auto custom-scrollbar">Loading...</div>
                </div>
                <div class="glass-panel p-6 rounded-2xl h-[400px] flex flex-col">
                    <h3 class="text-lg font-bold text-white mb-4">Users</h3>
                    <div class="flex-1 overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left text-sm text-slate-400">
                            <thead class="bg-slate-800/50 text-slate-200 sticky top-0"><tr><th class="p-2">User</th><th class="p-2">Plan</th><th class="p-2">Expires</th></tr></thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div id="admin-toast" class="fixed top-20 right-6 max-w-xs bg-slate-800 border-l-4 border-emerald-500 shadow-2xl rounded-lg p-4 hidden z-50 notification-pop">
            <div class="flex items-start gap-3">
                <div class="bg-emerald-500/20 p-2 rounded-full"><i data-lucide="bell" class="w-5 h-5 text-emerald-500"></i></div>
                <div><h3 class="font-bold text-white text-sm">New Payment!</h3><p class="text-xs text-slate-400 mt-1">A user uploaded proof.</p></div>
                <button onclick="document.getElementById('admin-toast').classList.add('hidden')" class="ml-auto text-slate-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <!-- TOOL VIEW -->
    <div id="tool-view" class="absolute inset-0 z-30 bg-[#0B1120] hidden flex flex-col">
        <div class="border-b border-slate-800 bg-[#0F172A] px-6 py-3 flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg"><i data-lucide="mic" class="w-5 h-5 text-white"></i></div>
                <div><h1 class="text-lg font-bold text-white">Creator Studio</h1><p class="text-[10px] text-slate-400">User: <span id="user-display-name" class="text-indigo-400 font-bold">Guest</span></p></div>
            </div>
            <div class="flex items-center gap-3">
                <button id="admin-back-btn" onclick="backToAdmin()" class="hidden px-3 py-1 bg-slate-700 text-white text-xs rounded border border-slate-600">Back</button>
                <button id="upgrade-btn-nav" class="hidden flex items-center gap-2 px-4 py-1.5 bg-gradient-to-r from-amber-500 to-orange-600 text-white text-xs font-bold rounded-full shadow-lg upgrade-trigger"><i data-lucide="crown" class="w-3 h-3"></i> Upgrade</button>
                <span id="user-plan-badge" class="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded border border-slate-700 uppercase font-bold">Free</span>
                <button onclick="toggleSettings(true)" class="p-2 text-slate-400 hover:text-white"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <button onclick="logout()" class="p-2 text-red-400 hover:text-red-300"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </div>
        <div class="flex-1 p-4 md:p-8 max-w-6xl mx-auto w-full grid lg:grid-cols-2 gap-6 overflow-y-auto">
            <div class="flex flex-col gap-4">
                <div class="bg-[#1E293B] border border-slate-700 rounded-3xl p-1 flex-1 flex flex-col shadow-xl min-h-[300px] relative">
                    <textarea id="text-input" class="flex-1 w-full bg-transparent text-lg p-6 resize-none outline-none text-slate-200 placeholder:text-slate-600" placeholder="Paste script..."></textarea>
                    <div id="limit-overlay" class="hidden absolute bottom-12 left-4 right-4 bg-red-500/10 border border-red-500/30 text-red-300 p-3 rounded-xl backdrop-blur-md text-xs flex justify-between items-center"><span><i data-lucide="lock" class="w-3 h-3 inline mr-1"></i> Free Limit (200 chars)</span><button class="underline hover:text-white upgrade-trigger font-bold">Upgrade Now</button></div>
                    <div class="px-6 py-3 border-t border-slate-700/50 flex justify-between items-center"><span class="text-xs text-slate-500 font-mono"><span id="char-count">0</span> / <span id="max-chars">200</span> chars</span></div>
                </div>
            </div>
            <div class="flex flex-col gap-4">
                <div class="bg-[#1E293B] border border-slate-700 rounded-3xl h-[450px] flex flex-col overflow-hidden relative shadow-xl">
                    <div id="panel-upgrade-btn" class="hidden absolute top-14 left-0 right-0 bg-amber-500/10 border-y border-amber-500/20 p-2 flex justify-between items-center px-6 z-20 backdrop-blur-sm"><span class="text-[10px] text-amber-300 font-bold">Unlock All Voices</span><button class="text-[10px] bg-amber-500 text-black px-2 py-1 rounded font-bold hover:bg-amber-400 upgrade-trigger">Unlock</button></div>
                    <div class="px-6 py-4 border-b border-slate-700 bg-[#1E293B] sticky top-0 z-10 flex justify-between"><span class="text-xs font-bold text-slate-400 uppercase">AI Voices</span><i data-lucide="sliders-horizontal" class="w-4 h-4 text-slate-500"></i></div>
                    <div class="p-4 bg-[#162032] border-b border-slate-700 mt-8"><div class="flex justify-between mb-1 text-xs font-medium text-slate-400"><span>Speed</span><span id="speed-val" class="text-emerald-400">1.0x</span></div><input type="range" id="speed-range" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full"></div>
                    <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar" id="voice-list"></div>
                </div>
                <div class="bg-[#1E293B] border border-slate-700 rounded-3xl p-6 shadow-xl relative overflow-hidden">
                    <div class="relative z-10 space-y-4">
                        <div id="progress-container" class="hidden space-y-2"><div class="flex justify-between text-xs font-bold text-emerald-400"><span>Generating...</span><span id="progress-pct">0%</span></div><div class="h-2 bg-slate-700 rounded-full overflow-hidden"><div id="progress-bar" class="h-full bg-emerald-500 transition-all duration-300 w-0"></div></div></div>
                        <button id="generate-btn" onclick="generateAudio()" class="w-full py-4 bg-emerald-500 hover:bg-emerald-400 text-[#0B1120] font-bold rounded-xl shadow-lg flex items-center justify-center gap-2"><i data-lucide="wand-2" class="w-5 h-5"></i> Generate Audio</button>
                        <div id="result-container" class="hidden space-y-3"><div class="bg-slate-900/50 p-2 rounded-xl border border-slate-700"><audio id="audio-player" controls class="w-full h-8"></audio></div><div class="relative"><a id="download-link" href="#" download class="flex items-center justify-center gap-2 w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium"><i data-lucide="download" class="w-4 h-4"></i> Download</a><div id="download-lock" class="absolute inset-0 bg-slate-900/80 backdrop-blur-[1px] flex items-center justify-center rounded-xl cursor-pointer upgrade-trigger"><span class="text-xs font-bold text-amber-400 flex items-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> Upgrade</span></div></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UPGRADE MODAL -->
    <div id="upgrade-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center hidden p-4">
        <div class="bg-[#1E293B] border border-slate-700 rounded-3xl w-full max-w-md p-6 shadow-2xl relative">
            <button onclick="toggleUpgrade(false)" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="text-center mb-6"><div class="inline-flex p-3 rounded-full bg-amber-500/20 text-amber-400 mb-3"><i data-lucide="crown" class="w-8 h-8"></i></div><h2 class="text-2xl font-bold text-white">Upgrade to Pro</h2><p class="text-slate-400 text-sm mt-1">$1.00 / Month (300 PKR)</p></div>
            <div class="space-y-4">
                <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700 flex justify-between"><div><p class="text-[10px] font-bold text-slate-400 uppercase">JazzCash</p><p class="text-white font-mono text-lg">03222547740</p><p class="text-xs text-emerald-400">Naveed Akhtar</p></div><button onclick="navigator.clipboard.writeText('03222547740')" class="p-2 bg-slate-700 rounded hover:bg-slate-600"><i data-lucide="copy" class="w-4 h-4"></i></button></div>
                <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700 flex justify-between"><div><p class="text-[10px] font-bold text-slate-400 uppercase">Binance</p><p class="text-white font-mono text-sm">YOUR_BINANCE_ID</p></div><button onclick="navigator.clipboard.writeText('YOUR_BINANCE_ID')" class="p-2 bg-slate-700 rounded hover:bg-slate-600"><i data-lucide="copy" class="w-4 h-4"></i></button></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Upload Proof</label><input type="file" id="proof-file" accept="image/*" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-600 file:text-white"/></div>
                <button onclick="submitUpgradeRequest()" class="w-full py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold rounded-xl shadow-lg">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="settings-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center hidden"><div class="bg-[#1E293B] border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl"><h3 class="text-white font-bold mb-4">API Key</h3><input id="api-key-input" type="password" placeholder="Paste Gemini Key..." class="w-full bg-[#0B1120] border border-slate-700 rounded-xl px-4 py-3 text-sm mb-3"><div class="flex gap-2"><button onclick="saveApiKey()" class="flex-1 bg-indigo-600 text-white py-2 rounded-xl">Save</button><button onclick="toggleSettings(false)" class="px-4 bg-slate-700 text-white rounded-xl">Close</button></div></div></div>

    <script>
        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = "https://sbivtpblakhopcrxmkfn.supabase.co";
        const SUPABASE_KEY = "sb_publishable__scEYcv0MWW-W51dmvCxDw_QZtWkbmZ";
        
        // --- APP SETUP ---
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const CHUNK_SIZE = 4000;
        const ADMIN_USER = "growwithhaider";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        const el = (id) => document.getElementById(id);
        let state = { user: null, voice: "Fenrir", keys: [], speed: 1.0 };
        
        function createClient(url, key) { return window.supabase.createClient(url, key); }

        async function init() {
            lucide.createIcons();
            const s = sessionStorage.getItem('session');
            if(s) loginSuccess(JSON.parse(s));
            
            el('text-input').oninput = handleInput;
            el('speed-range').oninput = (e) => { state.speed = parseFloat(e.target.value); el('speed-val').innerText = state.speed + 'x'; };
            document.querySelectorAll('.upgrade-trigger').forEach(b => b.onclick = () => toggleUpgrade(true));
            renderVoices();
        }

        // --- AUTH ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const u = el('login-user').value.toLowerCase().trim();
            const p = el('login-pass').value.trim();

            try {
                const { data, error } = await supabase.from('users').select('*').eq('username', u).eq('password', p).single();
                if(error || !data) return alert("Invalid credentials");
                loginSuccess(data);
            } catch(e) { alert("Login failed. Check internet."); }
        }

        window.handleSignup = async (e) => {
            e.preventDefault();
            const u = el('signup-user').value.toLowerCase().replace(/\s/g,'');
            const p = el('signup-pass').value;
            const em = el('signup-email').value;

            try {
                const { data: exists } = await supabase.from('users').select('username').eq('username', u).single();
                if(exists) return alert("Username taken");

                const { error } = await supabase.from('users').insert([{ username: u, password: p, email: em, plan: 'free', role: 'user' }]);
                if(error) throw error;
                
                alert("Account created! Login now.");
                toggleAuthMode('login');
            } catch(e) { alert("Signup error: " + e.message); }
        }

        function loginSuccess(user) {
            state.user = user;
            sessionStorage.setItem('session', JSON.stringify(user));
            el('auth-view').classList.add('hidden');
            if(user.role === 'admin') {
                el('admin-view').classList.remove('hidden');
                initAdminRealtime();
            } else {
                el('tool-view').classList.remove('hidden');
                setupUserUI();
            }
        }

        // --- ADMIN REALTIME ---
        function initAdminRealtime() {
            loadAdminData();
            supabase.channel('admin-dashboard')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'requests' }, payload => {
                showAdminNotification();
                loadAdminData();
            })
            .subscribe();
        }

        async function loadAdminData() {
            const { data: users } = await supabase.from('users').select('*');
            const { data: reqs } = await supabase.from('requests').select('*');
            
            el('admin-total-users').innerText = users.length;
            const pending = reqs.filter(r => r.status === 'pending');
            el('admin-pending-count').innerText = pending.length;
            el('admin-notification-dot').style.display = pending.length > 0 ? 'block' : 'none';
            
            let rev = 0; users.forEach(u => { if(u.plan === 'pro') rev += 1; });
            el('admin-revenue').innerText = rev.toFixed(2);

            el('requests-list').innerHTML = pending.map(r => `
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-2">
                    <div class="flex justify-between"><span class="font-bold">${r.username}</span></div>
                    <div class="h-24 bg-black rounded overflow-hidden relative my-2 cursor-pointer" onclick="window.open('${r.image}')"><img src="${r.image}" class="w-full h-full object-contain"></div>
                    <div class="flex gap-2"><button onclick="handleReq(${r.id}, 'approve', '${r.username}')" class="flex-1 bg-emerald-600 text-xs py-1 rounded">Approve</button><button onclick="handleReq(${r.id}, 'reject')" class="flex-1 bg-red-600 text-xs py-1 rounded">Reject</button></div>
                </div>
            `).join('') || '<p class="text-slate-500 text-center text-sm py-4">No pending requests</p>';

            el('user-table-body').innerHTML = users.map(u => `
                <tr class="border-b border-slate-800"><td class="p-2">${u.username}</td><td class="p-2"><span class="px-2 py-0.5 rounded text-[10px] ${u.plan==='pro'?'bg-emerald-900 text-emerald-400':'bg-slate-700'}">${u.plan}</span></td><td class="p-2"><button onclick="deleteUser(${u.id})" class="text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>
            `).join('');
            lucide.createIcons();
        }

        window.handleReq = async (id, action, username) => {
            if(action === 'approve') {
                await supabase.from('users').update({ plan: 'pro', plan_expires: Date.now() + (30*24*60*60*1000) }).eq('username', username);
            }
            await supabase.from('requests').update({ status: action }).eq('id', id);
            loadAdminData();
        }
        
        window.deleteUser = async (id) => { if(confirm("Delete?")) { await supabase.from('users').delete().eq('id', id); loadAdminData(); } }

        // --- USER LOGIC ---
        window.submitUpgradeRequest = () => {
            const file = el('proof-file').files[0];
            if(!file) return alert("Upload proof");
            const reader = new FileReader();
            reader.onload = async (e) => {
                await supabase.from('requests').insert([{ username: state.user.username, image: e.target.result }]);
                alert("Request Sent!"); toggleUpgrade(false);
            };
            reader.readAsDataURL(file);
        }

        // UI Helpers
        function setupUserUI() { 
            el('user-display-name').innerText = state.user.username;
            const isPro = state.user.plan === 'pro' || state.user.role === 'admin';
            el('user-plan-badge').innerText = isPro ? 'PRO' : 'FREE';
            el('max-chars').innerText = isPro ? 'âˆž' : '200';
            if(isPro) { el('download-lock').classList.add('hidden'); el('upgrade-btn-nav').classList.add('hidden'); el('panel-upgrade-btn').classList.add('hidden'); }
            else { el('download-lock').classList.remove('hidden'); el('upgrade-btn-nav').classList.remove('hidden'); el('panel-upgrade-btn').classList.remove('hidden'); }
            
            const keys = localStorage.getItem(`keys_${state.user.username}`);
            if(keys) state.keys = JSON.parse(keys);
            el('active-keys-count').innerText = `${state.keys.length} Keys`;
        }

        window.handleInput = (e) => {
            const val = e.target.value; state.text = val; el('char-count').innerText = val.length;
            if(state.user?.role !== 'admin' && state.user?.plan === 'free' && val.length > 200) el('limit-overlay').classList.remove('hidden'); else el('limit-overlay').classList.add('hidden');
        }

        // --- CORE & API ---
        const VOICES = [ { id: "Fenrir", gender: "Male", desc: "Deep", premium: false }, { id: "Kore", gender: "Female", desc: "Soft", premium: false }, { id: "Puck", gender: "Male", desc: "Energetic", premium: true }, { id: "Charon", gender: "Male", desc: "Deep", premium: true }, { id: "Aoede", gender: "Female", desc: "Warm", premium: true }, { id: "Zephyr", gender: "Male", desc: "Smooth", premium: true }, { id: "Leda", gender: "Female", desc: "Gentle", premium: true }, { id: "Orus", gender: "Male", desc: "Confident", premium: true }, { id: "Umbriel", gender: "Male", desc: "Steady", premium: true }, { id: "Iapetus", gender: "Male", desc: "Serious", premium: true } ];

        function renderVoices() {
            const isFree = state.user?.role !== 'admin' && state.user?.plan === 'free';
            el('voice-list').innerHTML = VOICES.map(v => {
                const locked = isFree && v.premium;
                return `<div onclick="${locked ? "toggleModal('upgrade', true)" : `selectVoice('${v.id}')`}" class="p-3 rounded-xl cursor-pointer flex items-center justify-between group ${state.voice===v.id?'bg-emerald-600/20 border border-emerald-500/50':'hover:bg-slate-800 border border-transparent'} ${locked?'opacity-50':''}">
                    <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${state.voice===v.id?'bg-emerald-500 text-white':'bg-slate-700 text-slate-400'}">${locked ? '<i data-lucide="lock" class="w-3 h-3"></i>' : v.id[0]}</div><div><h4 class="text-sm font-bold text-white">${v.id}</h4><p class="text-[10px] text-slate-500">${v.gender}</p></div></div></div>`;
            }).join('');
            lucide.createIcons();
        }
        window.selectVoice = (id) => { state.voice = id; renderVoices(); };
        
        window.generateAudio = async () => {
            if(!state.text.trim()) return alert("Enter text");
            if(state.user.role!=='admin' && state.user.plan==='free' && state.text.length>200) return toggleUpgrade(true);
            if(state.keys.length===0) return toggleModal('settings', true);

            setIsGenerating(true);
            try {
                const chunks = chunkText(state.text);
                let completed = 0;
                const promises = chunks.map(async (chunk, idx) => {
                    const buf = await fetchAudio(chunk);
                    completed++; el('progress-bar').style.width = `${(completed/chunks.length)*100}%`;
                    return { idx, buf };
                });
                const results = await Promise.all(promises);
                results.sort((a,b) => a.idx - b.idx);
                const blob = new Blob(results.map(r => r.buf), { type: 'audio/mp3' });
                const url = URL.createObjectURL(blob);
                el('audio-player').src = url; el('download-link').href = url;
                el('download-link').download = `voice-${state.voice}-${Date.now()}.mp3`;
                el('result-container').classList.remove('hidden');
            } catch(e) { alert("Error: "+e.message); } 
            finally { setIsGenerating(false); }
        }
        
        async function fetchAudio(text) {
            let attempts = 0;
            while(attempts < state.keys.length) {
                const key = state.keys[state.keyIdx];
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${key}`, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contents: [{parts:[{text}]}], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: state.voice } } } } }) });
                    if(!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    const bin = atob(data.candidates[0].content.parts[0].inlineData.data);
                    const bytes = new Uint8Array(bin.length);
                    for(let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
                    return bytes.buffer;
                } catch(e) { state.keyIdx=(state.keyIdx+1)%state.keys.length; attempts++; }
            }
            throw new Error("Keys Exhausted");
        }

        function chunkText(str) { const c=[]; let cur=""; str.match(/[^.!?]+[.!?]+|[^.!?]+$/g).forEach(s=>{ if(cur.length+s.length<CHUNK_SIZE) cur+=s; else { if(cur) c.push(cur); cur=s; } }); if(cur) c.push(cur); return c; }
        
        window.toggleAuthMode = (m) => { el('login-form-container').classList.toggle('hidden', m!=='login'); el('signup-form-container').classList.toggle('hidden', m!=='signup'); }
        window.toggleModal = (id, s) => el('modal-'+id).classList.toggle('hidden', !s);
        window.toggleUpgrade = (s) => toggleModal('upgrade', s);
        window.toggleSettings = (s) => toggleModal('settings', s);
        window.logout = () => { sessionStorage.removeItem('session'); location.reload(); }
        window.saveApiKey = () => { const k=el('api-key-input').value.trim(); if(k) { let keys=JSON.parse(localStorage.getItem(`keys_${state.user.username}`)||'[]'); keys.push(k); localStorage.setItem(`keys_${state.user.username}`, JSON.stringify(keys)); state.keys=keys; el('api-key-input').value=""; el('active-keys-count').innerText=`${state.keys.length} Keys`; alert("Saved"); } }
        window.goToToolAsAdmin = () => { el('admin-view').classList.add('hidden'); el('tool-view').classList.remove('hidden'); setupUserUI(); }
        window.backToAdmin = () => { el('tool-view').classList.add('hidden'); el('admin-view').classList.remove('hidden'); loadAdminData(); }
        function setIsGenerating(v) { if(v) { el('generate-btn').disabled=true; el('progress-container').classList.remove('hidden'); } else { el('generate-btn').disabled=false; } }
        function showAdminNotification() { el('admin-toast').classList.remove('hidden'); setTimeout(()=>el('admin-toast').classList.add('hidden'),5000); }

        init();
    </script>
</body>
</html>
