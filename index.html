<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Creator Studio - Admin Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #10b981; /* Emerald-500 */
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
        
        /* Audio Player Customization */
        audio {
            filter: invert(1) hue-rotate(180deg);
            opacity: 0.9;
            border-radius: 0.5rem;
        }

        .glass-panel { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Notification Animation */
        @keyframes bounce-in {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .notification-pop { animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="bg-[#0B1120] text-white font-sans h-screen flex flex-col overflow-hidden">

    <!-- ================= 1. AUTH VIEW (Login/Signup) ================= -->
    <div id="auth-view" class="absolute inset-0 z-50 flex items-center justify-center bg-[#0B1120]">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md shadow-2xl relative overflow-hidden">
            
            <!-- Login Form -->
            <div id="login-form-container">
                <div class="text-center mb-8">
                    <div class="inline-flex p-3 rounded-xl bg-indigo-600/20 text-indigo-400 mb-4"><i data-lucide="lock" class="w-8 h-8"></i></div>
                    <h1 class="text-2xl font-bold text-white">Welcome Back</h1>
                    <p class="text-slate-400 text-sm mt-1">Login to AI Creator Studio</p>
                </div>
                <form id="login-form" class="space-y-4" onsubmit="handleLogin(event)">
                    <input type="text" id="login-user" class="w-full bg-[#0f172a] border border-slate-700 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 transition-all" placeholder="Username">
                    <input type="password" id="login-pass" class="w-full bg-[#0f172a] border border-slate-700 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 transition-all" placeholder="Password">
                    <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl shadow-lg transform active:scale-95 transition-all">Login</button>
                </form>
                <p class="text-center text-xs text-slate-500 mt-4">
                    New here? <button onclick="toggleAuthMode('signup')" class="text-indigo-400 hover:underline font-bold">Create Account</button>
                </p>
            </div>

            <!-- Signup Form -->
            <div id="signup-form-container" class="hidden">
                <div class="text-center mb-8">
                    <div class="inline-flex p-3 rounded-xl bg-emerald-600/20 text-emerald-400 mb-4"><i data-lucide="user-plus" class="w-8 h-8"></i></div>
                    <h1 class="text-2xl font-bold text-white">Create Account</h1>
                    <p class="text-slate-400 text-sm mt-1">Start with Free Plan</p>
                </div>
                <form id="signup-form" class="space-y-4" onsubmit="handleSignup(event)">
                    <input type="email" id="signup-email" required class="w-full bg-[#0f172a] border border-slate-700 rounded-xl px-4 py-3 text-white outline-none focus:border-emerald-500 transition-all" placeholder="Email Address (Required)">
                    <input type="text" id="signup-user" required class="w-full bg-[#0f172a] border border-slate-700 rounded-xl px-4 py-3 text-white outline-none focus:border-emerald-500 transition-all" placeholder="Username (no spaces)">
                    <input type="password" id="signup-pass" required class="w-full bg-[#0f172a] border border-slate-700 rounded-xl px-4 py-3 text-white outline-none focus:border-emerald-500 transition-all" placeholder="Choose Password">
                    <button type="submit" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg transform active:scale-95 transition-all">Sign Up</button>
                </form>
                <p class="text-center text-xs text-slate-500 mt-4">
                    Already have an account? <button onclick="toggleAuthMode('login')" class="text-emerald-400 hover:underline font-bold">Login</button>
                </p>
            </div>

            <p id="auth-error" class="text-red-400 text-xs text-center mt-4 hidden bg-red-500/10 p-2 rounded border border-red-500/20"></p>
        </div>
    </div>

    <!-- ================= 2. ADMIN PANEL ================= -->
    <div id="admin-view" class="absolute inset-0 z-40 bg-[#0B1120] hidden flex flex-col">
        <div class="border-b border-slate-800 bg-[#0f172a] px-6 py-4 flex justify-between items-center shadow-md">
            <h2 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="shield" class="w-5 h-5 text-emerald-500"></i> Admin Dashboard</h2>
            <div class="flex gap-3">
                <button onclick="goToToolAsAdmin()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg flex items-center gap-2 shadow-lg">
                    <i data-lucide="mic" class="w-4 h-4"></i> Open Generator
                </button>
                <button onclick="logout()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-red-400 text-xs font-bold rounded-lg border border-slate-700">Logout</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 max-w-7xl mx-auto w-full space-y-8">
            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="glass-panel p-6 rounded-2xl border-l-4 border-indigo-500">
                    <p class="text-slate-400 text-xs uppercase font-bold">Total Users</p>
                    <h3 class="text-3xl font-bold text-white mt-1" id="admin-total-users">0</h3>
                </div>
                <div class="glass-panel p-6 rounded-2xl border-l-4 border-emerald-500">
                    <p class="text-slate-400 text-xs uppercase font-bold">Active Revenue</p>
                    <h3 class="text-3xl font-bold text-white mt-1">$<span id="admin-revenue">0</span></h3>
                </div>
                <div class="glass-panel p-6 rounded-2xl border-l-4 border-amber-500 relative group cursor-pointer hover:bg-slate-800/50 transition-colors">
                    <p class="text-slate-400 text-xs uppercase font-bold">Pending Requests</p>
                    <h3 class="text-3xl font-bold text-white mt-1" id="admin-pending-count">0</h3>
                    <!-- Notification Dot -->
                    <span class="absolute top-4 right-4 h-4 w-4 bg-red-500 rounded-full animate-pulse hidden shadow-[0_0_10px_rgba(239,68,68,0.8)]" id="admin-notification-dot"></span>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Payment Requests -->
                <div class="glass-panel p-6 rounded-2xl h-[400px] flex flex-col">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="credit-card" class="w-5 h-5 text-amber-400"></i> Upgrade Requests
                        <span id="new-req-badge" class="hidden bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full animate-pulse">NEW!</span>
                    </h3>
                    <div id="requests-list" class="space-y-3 flex-1 overflow-y-auto custom-scrollbar pr-2">
                        <!-- Requests Injected Here -->
                        <div class="flex flex-col items-center justify-center h-full text-slate-500">
                            <i data-lucide="inbox" class="w-8 h-8 mb-2 opacity-50"></i>
                            <p class="text-sm italic">No pending requests.</p>
                        </div>
                    </div>
                </div>

                <!-- User Database -->
                <div class="glass-panel p-6 rounded-2xl h-[400px] flex flex-col">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5 text-blue-400"></i> User Database</h3>
                    <div class="flex-1 overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left text-sm text-slate-400">
                            <thead class="bg-slate-800/50 text-slate-200 sticky top-0">
                                <tr><th class="p-2">User/Email</th><th class="p-2">Plan</th><th class="p-2">Expires</th><th class="p-2">Action</th></tr>
                            </thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Toast Notification -->
        <div id="admin-toast" class="fixed top-20 right-6 max-w-xs bg-slate-800 border-l-4 border-emerald-500 shadow-2xl rounded-lg p-4 hidden z-50 notification-pop">
            <div class="flex items-start gap-3">
                <div class="bg-emerald-500/20 p-2 rounded-full"><i data-lucide="bell" class="w-5 h-5 text-emerald-500"></i></div>
                <div>
                    <h3 class="font-bold text-white text-sm">New Payment!</h3>
                    <p class="text-xs text-slate-400 mt-1">Check pending requests.</p>
                </div>
                <button onclick="document.getElementById('admin-toast').classList.add('hidden')" class="ml-auto text-slate-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <!-- ================= 3. MAIN TOOL VIEW ================= -->
    <div id="tool-view" class="absolute inset-0 z-30 bg-[#0B1120] hidden flex flex-col">
        <!-- Navbar -->
        <div class="border-b border-slate-800 bg-[#0F172A] px-6 py-3 flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg"><i data-lucide="mic" class="w-5 h-5 text-white"></i></div>
                <div>
                    <h1 class="text-lg font-bold text-white">Creator Studio</h1>
                    <p class="text-[10px] text-slate-400">User: <span id="user-display-name" class="text-indigo-400 font-bold">Guest</span></p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="admin-back-btn" onclick="backToAdmin()" class="hidden px-3 py-1 bg-slate-700 text-white text-xs rounded hover:bg-slate-600 border border-slate-600">Back to Admin</button>
                
                <!-- UPGRADE BUTTON (NAVBAR) -->
                <button id="upgrade-btn-nav" class="hidden flex items-center gap-2 px-4 py-1.5 bg-gradient-to-r from-amber-500 to-orange-600 text-white text-xs font-bold rounded-full shadow-lg hover:shadow-orange-500/20 transition-all transform hover:scale-105 upgrade-trigger">
                    <i data-lucide="crown" class="w-3 h-3"></i> Upgrade
                </button>

                <span id="user-plan-badge" class="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded border border-slate-700 uppercase font-bold tracking-wide">Free</span>
                
                <button onclick="toggleSettings(true)" class="p-2 text-slate-400 hover:text-white transition-colors"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <button onclick="logout()" class="p-2 text-red-400 hover:text-red-300 transition-colors"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </div>

        <!-- Tool Content -->
        <div class="flex-1 p-4 md:p-8 max-w-6xl mx-auto w-full grid lg:grid-cols-2 gap-6 overflow-y-auto">
            <!-- Left: Input -->
            <div class="flex flex-col gap-4">
                <div class="bg-[#1E293B] border border-slate-700 rounded-3xl p-1 flex-1 flex flex-col shadow-xl min-h-[300px] relative">
                    <textarea id="text-input" class="flex-1 w-full bg-transparent text-lg p-6 resize-none outline-none text-slate-200 placeholder:text-slate-600" placeholder="Paste your script here..."></textarea>
                    
                    <!-- Free Limit Overlay -->
                    <div id="limit-overlay" class="hidden absolute bottom-12 left-4 right-4 bg-red-500/10 border border-red-500/30 text-red-300 p-3 rounded-xl backdrop-blur-md text-xs flex justify-between items-center">
                        <span><i data-lucide="lock" class="w-3 h-3 inline mr-1"></i> Free Limit (200 chars)</span>
                        <button class="underline hover:text-white upgrade-trigger font-bold">Upgrade Now</button>
                    </div>
                    <div class="px-6 py-3 border-t border-slate-700/50 flex justify-between items-center">
                        <span class="text-xs text-slate-500 font-mono"><span id="char-count">0</span> / <span id="max-chars">200</span> chars</span>
                        <span id="pro-status" class="text-[10px] text-amber-500 font-bold hidden bg-amber-500/10 px-2 py-1 rounded border border-amber-500/20">PRO ACTIVE</span>
                    </div>
                </div>
            </div>

            <!-- Right: Controls -->
            <div class="flex flex-col gap-4">
                <div class="bg-[#1E293B] border border-slate-700 rounded-3xl h-[450px] flex flex-col overflow-hidden relative shadow-xl">
                    <!-- Upgrade Banner Inside Panel -->
                    <div id="panel-upgrade-btn" class="hidden absolute top-14 left-0 right-0 bg-amber-500/10 border-y border-amber-500/20 p-2 flex justify-between items-center px-6 z-20 backdrop-blur-sm">
                        <span class="text-[10px] text-amber-300 font-bold">Unlock All Voices</span>
                        <button class="text-[10px] bg-amber-500 text-black px-2 py-1 rounded font-bold hover:bg-amber-400 upgrade-trigger">Unlock</button>
                    </div>

                    <div class="px-6 py-4 border-b border-slate-700 bg-[#1E293B] sticky top-0 z-10 flex justify-between">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">AI Voices</span>
                        <i data-lucide="sliders-horizontal" class="w-4 h-4 text-slate-500"></i>
                    </div>
                    <div class="p-4 bg-[#162032] border-b border-slate-700 mt-8">
                        <div class="flex justify-between mb-1 text-xs font-medium text-slate-400"><span>Speed</span><span id="speed-val" class="text-emerald-400">1.0x</span></div>
                        <input type="range" id="speed-range" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full">
                    </div>
                    <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar" id="voice-list"></div>
                </div>

                <div class="bg-[#1E293B] border border-slate-700 rounded-3xl p-6 shadow-xl relative overflow-hidden">
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-emerald-500/20 rounded-full blur-3xl"></div>
                    <div class="relative z-10 space-y-4">
                        <div id="progress-container" class="hidden space-y-2">
                            <div class="flex justify-between text-xs font-bold text-emerald-400"><span>Generating...</span><span id="progress-pct">0%</span></div>
                            <div class="h-2 bg-slate-700 rounded-full overflow-hidden"><div id="progress-bar" class="h-full bg-emerald-500 transition-all duration-300 w-0"></div></div>
                        </div>
                        <button id="generate-btn" class="w-full py-4 bg-emerald-500 hover:bg-emerald-400 text-[#0B1120] font-bold rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 active:scale-95">
                            <i data-lucide="wand-2" class="w-5 h-5"></i> Generate Audio
                        </button>
                        <div id="result-container" class="hidden animate-in fade-in slide-in-from-bottom-2 space-y-3">
                            <div class="bg-slate-900/50 p-2 rounded-xl border border-slate-700"><audio id="audio-player" controls class="w-full h-8"></audio></div>
                            <div class="relative">
                                <a id="download-link" href="#" download class="flex items-center justify-center gap-2 w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium transition-colors"><i data-lucide="download" class="w-4 h-4"></i> Download</a>
                                <div id="download-lock" class="absolute inset-0 bg-slate-900/80 backdrop-blur-[1px] flex items-center justify-center rounded-xl cursor-pointer upgrade-trigger">
                                    <span class="text-xs font-bold text-amber-400 flex items-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> Upgrade to Download</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UPGRADE MODAL -->
    <div id="upgrade-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center hidden p-4">
        <div class="bg-[#1E293B] border border-slate-700 rounded-3xl w-full max-w-md p-6 shadow-2xl relative animate-in zoom-in-95">
            <button onclick="toggleUpgrade(false)" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            
            <div class="text-center mb-6">
                <div class="inline-flex p-3 rounded-full bg-amber-500/20 text-amber-400 mb-3"><i data-lucide="crown" class="w-8 h-8"></i></div>
                <h2 class="text-2xl font-bold text-white">Upgrade to Pro</h2>
                <p class="text-slate-400 text-sm mt-1">$1.00 / Month (Approx 300 PKR)</p>
            </div>

            <div class="space-y-4">
                <!-- JazzCash -->
                <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Option 1: JazzCash</p>
                        <p class="text-white font-mono text-lg">0322547740</p>
                        <p class="text-xs text-emerald-400">Naveed Akhtar</p>
                    </div>
                    <button onclick="navigator.clipboard.writeText('0322547740'); alert('Copied!')" class="p-2 bg-slate-700 rounded hover:bg-slate-600 text-slate-300"><i data-lucide="copy" class="w-4 h-4"></i></button>
                </div>

                <!-- Binance -->
                <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Option 2: Binance Pay</p>
                        <p class="text-white font-mono text-sm">Add Binance ID</p> 
                        <p class="text-xs text-amber-400">USDT / BUSD</p>
                    </div>
                    <button onclick="navigator.clipboard.writeText('Add Binance ID'); alert('Copied!')" class="p-2 bg-slate-700 rounded hover:bg-slate-600 text-slate-300"><i data-lucide="copy" class="w-4 h-4"></i></button>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Upload Proof (Screenshot)</label>
                    <input type="file" id="proof-file" accept="image/*" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-500"/>
                </div>

                <button onclick="submitUpgradeRequest()" class="w-full py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-all">
                    Submit Request
                </button>
                <p id="upgrade-status" class="text-center text-xs text-emerald-400 mt-2 hidden font-bold bg-emerald-500/10 p-2 rounded border border-emerald-500/20">Request Sent! Admin will approve soon.</p>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-start justify-center pt-20 hidden">
        <div class="bg-[#1E293B] border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-white font-bold mb-4 flex items-center gap-2"><i data-lucide="key" class="w-4 h-4 text-indigo-400"></i> API Key</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <label class="text-xs text-slate-400">Paste Gemini API Key</label>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1 hover:underline">Get API Key <i data-lucide="external-link" class="w-3 h-3"></i></a>
                </div>
                <input id="api-key-input" type="password" placeholder="AIza..." class="w-full bg-[#0B1120] border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 text-white mb-3">
                <div class="flex gap-2">
                    <button onclick="saveApiKey()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-xl text-sm font-bold">Add Key</button>
                    <button onclick="toggleSettings(false)" class="px-4 bg-slate-700 hover:bg-slate-600 text-white rounded-xl text-sm">Close</button>
                </div>
                <div class="text-xs text-slate-500 pt-2"><span id="active-keys-count">0 Keys Active</span></div>
            </div>
        </div>
    </div>

    <!-- ERROR TOAST -->
    <div id="error-toast" class="fixed bottom-6 right-6 max-w-sm bg-[#1E293B] border-l-4 border-red-500 shadow-2xl rounded-lg p-4 hidden z-50 animate-in slide-in-from-right">
        <div class="flex items-start gap-3">
            <i data-lucide="alert-circle" class="w-5 h-5 text-red-500 mt-0.5"></i>
            <div>
                <h3 class="font-bold text-red-400 text-sm">Error</h3>
                <p id="error-msg" class="text-xs text-slate-300 mt-1">Something went wrong.</p>
            </div>
            <button id="close-toast" class="ml-auto text-slate-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const ADMIN_USER = "GrowWithHaider";
        const ADMIN_PASS = "HaiderAli000";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const CHUNK_SIZE = 4000;
        const VOICES = [
            { id: "Fenrir", gender: "Male", desc: "Deep", premium: false }, { id: "Kore", gender: "Female", desc: "Soft", premium: false },
            { id: "Puck", gender: "Male", desc: "Energetic", premium: true }, { id: "Charon", gender: "Male", desc: "Deep", premium: true },
            { id: "Aoede", gender: "Female", desc: "Warm", premium: true }, { id: "Zephyr", gender: "Male", desc: "Smooth", premium: true },
            { id: "Leda", gender: "Female", desc: "Gentle", premium: true }, { id: "Orus", gender: "Male", desc: "Confident", premium: true },
            { id: "Umbriel", gender: "Male", desc: "Steady", premium: true }, { id: "Iapetus", gender: "Male", desc: "Serious", premium: true }
        ];

        let state = { user: null, text: "", voice: "Fenrir", keys: [], keyIdx: 0, gen: false, speed: 1.0 };
        const el = (id) => document.getElementById(id);
        
        function init() {
            lucide.createIcons();
            const sess = sessionStorage.getItem('session');
            if(sess) loginSuccess(JSON.parse(sess));
            
            // Real-time auto refresh for admin
            setInterval(() => {
                if(state.user?.role === 'admin') loadAdminPanel();
            }, 2000);

            el('text-input').oninput = handleInput;
            el('speed-range').oninput = (e) => { state.speed = parseFloat(e.target.value); el('speed-val').innerText = state.speed + 'x'; };
            document.querySelectorAll('.upgrade-trigger').forEach(b => b.onclick = () => toggleUpgrade(true));
            renderVoices();
        }

        // --- AUTH & USERNAME LOGIC ---
        window.toggleAuthMode = (mode) => {
            if(mode === 'signup') { el('login-form-container').classList.add('hidden'); el('signup-form-container').classList.remove('hidden'); }
            else { el('login-form-container').classList.remove('hidden'); el('signup-form-container').classList.add('hidden'); }
        }

        window.handleLogin = (e) => {
            e.preventDefault();
            const u = el('login-user').value.toLowerCase(), p = el('login-pass').value;
            if(u === ADMIN_USER.toLowerCase() && p === ADMIN_PASS) return loginSuccess({ username: 'Admin', role: 'admin' });

            const users = JSON.parse(localStorage.getItem('tts_users') || '[]');
            
            // Auto-Expiry Check on Login
            const userIdx = users.findIndex(x => x.username === u && x.password === p);
            if(userIdx > -1) {
                const user = users[userIdx];
                // Check expiration
                if (user.plan === 'pro' && user.planExpires && Date.now() > user.planExpires) {
                    user.plan = 'free'; // Downgrade
                    user.planExpires = null;
                    users[userIdx] = user;
                    localStorage.setItem('tts_users', JSON.stringify(users));
                    alert("Your Pro Plan has expired.");
                }
                loginSuccess(user);
            } else {
                showAuthError('Invalid credentials');
            }
        }

        window.handleSignup = (e) => {
            e.preventDefault();
            const email = el('signup-email').value;
            // Sanitize Username: Lowercase, No Spaces
            const uRaw = el('signup-user').value;
            const u = uRaw.toLowerCase().replace(/\s+/g, '');
            const p = el('signup-pass').value;

            if(!email || !u || !p) return showAuthError('All fields required');

            const users = JSON.parse(localStorage.getItem('tts_users') || '[]');
            if(users.find(x => x.username === u)) return showAuthError('Username already taken. Try another.');
            if(users.find(x => x.email === email)) return showAuthError('Email already registered.');

            const newUser = { 
                username: u, 
                email: email,
                password: p, 
                plan: 'free', 
                role: 'user',
                joined: Date.now()
            };
            users.push(newUser);
            localStorage.setItem('tts_users', JSON.stringify(users));
            loginSuccess(newUser);
            alert(`Account created! Your username is: ${u}`);
        }

        function showAuthError(msg) {
            const err = el('auth-error');
            err.innerText = msg;
            err.classList.remove('hidden');
            setTimeout(() => err.classList.add('hidden'), 3000);
        }

        function loginSuccess(user) {
            state.user = user;
            sessionStorage.setItem('session', JSON.stringify(user));
            el('auth-view').classList.add('hidden');
            
            if(user.role === 'admin') {
                el('admin-view').classList.remove('hidden');
                loadAdminPanel();
            } else {
                el('tool-view').classList.remove('hidden');
                setupUserUI();
            }
        }

        window.logout = () => { sessionStorage.removeItem('session'); location.reload(); }

        // --- USER UI ---
        function setupUserUI() {
            el('user-display-name').innerText = state.user.username;
            const plan = state.user.plan.toUpperCase();
            el('user-plan-badge').innerText = plan;
            el('user-plan-badge').className = `text-[10px] px-2 py-1 rounded border uppercase font-bold ${plan==='PRO'?'bg-emerald-900 text-emerald-400 border-emerald-700':'bg-slate-800 text-slate-400 border-slate-700'}`;
            
            const keys = localStorage.getItem(`keys_${state.user.username}`);
            if(keys) state.keys = JSON.parse(keys);
            el('active-keys-count').innerText = `${state.keys.length} Keys Active`;

            if(plan === 'PRO' || state.user.role === 'admin') {
                el('max-chars').innerText = 'âˆž';
                el('download-lock').classList.add('hidden');
                el('upgrade-btn-nav').classList.add('hidden');
                el('panel-upgrade-btn').classList.add('hidden');
            } else {
                el('max-chars').innerText = '200';
                el('download-lock').classList.remove('hidden');
                el('upgrade-btn-nav').classList.remove('hidden');
                el('panel-upgrade-btn').classList.remove('hidden');
            }
            renderVoices();
        }

        window.handleInput = (e) => {
            const val = e.target.value;
            state.text = val;
            el('char-count').innerText = val.length;
            if(state.user.role !== 'admin' && state.user.plan === 'free' && val.length > 200) el('limit-overlay').classList.remove('hidden');
            else el('limit-overlay').classList.add('hidden');
        }

        // --- ADMIN PANEL ---
        let lastRequestCount = 0;

        function loadAdminPanel() {
            const users = JSON.parse(localStorage.getItem('tts_users') || '[]');
            const reqs = JSON.parse(localStorage.getItem('tts_requests') || '[]');
            
            el('admin-total-users').innerText = users.length;
            
            const pending = reqs.filter(r => r.status === 'pending');
            el('admin-pending-count').innerText = pending.length;
            el('admin-notification-dot').style.display = pending.length > 0 ? 'block' : 'none';
            
            // Check for new notifications
            if(pending.length > lastRequestCount) {
                showAdminNotification();
            }
            lastRequestCount = pending.length;

            let rev = 0;
            users.forEach(u => { if(u.plan === 'pro') rev += 1; });
            el('admin-revenue').innerText = rev.toFixed(2);

            // Render Users
            el('user-table-body').innerHTML = users.map((u,i) => `
                <tr class="border-b border-slate-800">
                    <td class="p-2">
                        <div class="font-bold text-white">${u.username}</div>
                        <div class="text-xs text-slate-500">${u.email}</div>
                    </td>
                    <td class="p-2"><span class="px-2 py-0.5 rounded text-xs ${u.plan==='pro'?'bg-emerald-900 text-emerald-400':'bg-slate-700'}">${u.plan}</span></td>
                    <td class="p-2 text-xs font-mono">${u.planExpires ? new Date(u.planExpires).toLocaleDateString() : '-'}</td>
                    <td class="p-2"><button onclick="deleteUser(${i})" class="text-red-400 hover:text-red-300"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                </tr>
            `).join('');
            
            // Render Requests
            const reqHtml = reqs.map((r, i) => r.status === 'pending' ? `
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col gap-2 mb-2 animate-in fade-in">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-white text-sm">${r.username}</span>
                        <span class="text-[10px] text-slate-400">${new Date(r.date).toLocaleDateString()}</span>
                    </div>
                    <div class="h-24 bg-black rounded overflow-hidden relative group cursor-pointer border border-slate-600">
                        <img src="${r.image}" class="w-full h-full object-contain" onclick="window.open('${r.image}')">
                    </div>
                    <div class="flex gap-2 mt-1">
                        <button onclick="handleRequest(${i}, 'approve')" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white text-xs py-1.5 rounded-lg font-bold">Approve</button>
                        <button onclick="handleRequest(${i}, 'reject')" class="flex-1 bg-red-600 hover:bg-red-500 text-white text-xs py-1.5 rounded-lg font-bold">Reject</button>
                    </div>
                </div>
            ` : '').join('');
            el('requests-list').innerHTML = reqHtml || '<p class="text-slate-500 text-sm text-center italic py-4">No pending requests</p>';
            
            lucide.createIcons();
        }

        function showAdminNotification() {
            el('admin-toast').classList.remove('hidden');
            setTimeout(() => el('admin-toast').classList.add('hidden'), 5000);
        }

        window.handleRequest = (idx, action) => {
            const reqs = JSON.parse(localStorage.getItem('tts_requests') || '[]');
            const users = JSON.parse(localStorage.getItem('tts_users') || '[]');
            const req = reqs[idx];
            
            if(action === 'approve') {
                const uIdx = users.findIndex(u => u.username === req.username);
                if(uIdx > -1) {
                    users[uIdx].plan = 'pro';
                    // Set Expiry: 30 Days from now
                    users[uIdx].planExpires = Date.now() + (30 * 24 * 60 * 60 * 1000); 
                    localStorage.setItem('tts_users', JSON.stringify(users));
                }
                req.status = 'approved';
            } else {
                req.status = 'rejected';
            }
            
            localStorage.setItem('tts_requests', JSON.stringify(reqs));
            loadAdminPanel();
            alert(`Request ${action}d!`);
        }
        
        window.deleteUser = (i) => { if(confirm("Delete?")) { const u=JSON.parse(localStorage.getItem('tts_users')); u.splice(i,1); localStorage.setItem('tts_users',JSON.stringify(u)); loadAdminPanel(); } }
        window.goToToolAsAdmin = () => { el('admin-view').classList.add('hidden'); el('tool-view').classList.remove('hidden'); el('admin-back-btn').classList.remove('hidden'); setupUserUI(); }
        window.backToAdmin = () => { el('tool-view').classList.add('hidden'); el('admin-view').classList.remove('hidden'); loadAdminPanel(); }

        // --- UPGRADE LOGIC ---
        window.toggleUpgrade = (s) => el('upgrade-modal').classList.toggle('hidden', !s);
        
        window.submitUpgradeRequest = () => {
            const file = el('proof-file').files[0];
            if(!file) return alert("Upload proof");
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const reqs = JSON.parse(localStorage.getItem('tts_requests') || '[]');
                reqs.push({ username: state.user.username, image: e.target.result, status: 'pending', date: Date.now() });
                localStorage.setItem('tts_requests', JSON.stringify(reqs));
                
                el('upgrade-status').classList.remove('hidden');
                setTimeout(() => { el('upgrade-status').classList.add('hidden'); toggleUpgrade(false); }, 2000);
            };
            reader.readAsDataURL(file);
        }

        // --- CORE & API ---
        function renderVoices() {
            const isFree = state.user?.role !== 'admin' && state.user?.plan === 'free';
            el('voice-list').innerHTML = VOICES.map(v => {
                const locked = isFree && v.premium;
                return `<div onclick="${locked ? 'toggleUpgrade(true)' : `selectVoice('${v.id}')`}" class="p-3 rounded-xl cursor-pointer flex items-center justify-between group ${state.voice===v.id?'bg-emerald-600/20 border border-emerald-500/50':'hover:bg-slate-800 border border-transparent'} ${locked?'opacity-60':''}">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${state.voice===v.id?'bg-emerald-500 text-white':'bg-slate-700 text-slate-400'}">${locked ? '<i data-lucide="lock" class="w-3 h-3"></i>' : v.id[0]}</div>
                        <div><h4 class="text-sm font-bold text-white">${v.id}</h4><p class="text-[10px] text-slate-500">${v.gender}</p></div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }
        window.selectVoice = (id) => { state.voice = id; renderVoices(); };
        
        window.toggleSettings = (s) => el('settings-modal').classList.toggle('hidden', !s);
        window.saveApiKey = () => { const k=el('api-key-input').value.trim(); if(k) { state.keys.push(k); localStorage.setItem(`keys_${state.user.username}`,JSON.stringify(state.keys)); el('api-key-input').value=""; el('active-keys-count').innerText=`${state.keys.length} Keys`; alert("Saved"); } }

        window.generateAudio = async () => {
            if(!state.text.trim()) return alert("Enter text");
            if(state.user.role!=='admin' && state.user.plan==='free' && state.text.length>200) return toggleUpgrade(true);
            if(state.keys.length===0) { toggleSettings(true); return alert("Add Key"); }

            setIsGenerating(true);
            try {
                const chunks = chunkText(state.text);
                let completed = 0;
                const promises = chunks.map(async (chunk, idx) => {
                    const buf = await fetchAudio(chunk);
                    completed++;
                    el('progress-bar').style.width = `${(completed/chunks.length)*100}%`;
                    return { idx, buf };
                });
                const results = await Promise.all(promises);
                results.sort((a,b) => a.idx - b.idx);
                const blob = new Blob(results.map(r => r.buf), { type: 'audio/mp3' });
                const url = URL.createObjectURL(blob);
                el('audio-player').src = url;
                el('download-link').href = url;
                el('download-link').download = `audio-${Date.now()}.mp3`;
                el('result-container').classList.remove('hidden');
            } catch(e) { alert("Error: "+e.message); } 
            finally { setIsGenerating(false); }
        }

        async function fetchAudio(text) {
            let attempts = 0;
            while(attempts < state.keys.length) {
                const key = state.keys[state.currentKeyIndex];
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${key}`, {
                        method:'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ contents: [{parts:[{text}]}], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: state.voice } } } } })
                    });
                    if(!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    const bin = atob(data.candidates[0].content.parts[0].inlineData.data);
                    const bytes = new Uint8Array(bin.length);
                    for(let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
                    return bytes.buffer;
                } catch(e) { state.currentKeyIndex=(state.currentKeyIndex+1)%state.keys.length; attempts++; }
            }
            throw new Error("Keys Exhausted");
        }

        function chunkText(str) { const c=[]; let cur=""; str.match(/[^.!?]+[.!?]+|[^.!?]+$/g).forEach(s=>{ if(cur.length+s.length<CHUNK_SIZE) cur+=s; else { if(cur) c.push(cur); cur=s; } }); if(cur) c.push(cur); return c; }
        function setIsGenerating(val) { state.isGenerating=val; if(val){ els.generateBtn.disabled=true; els.generateBtn.innerText="Processing..."; els.progressContainer.classList.remove('hidden'); els.resultContainer.classList.add('hidden'); } else { els.generateBtn.disabled=false; els.generateBtn.innerText="Generate Audio"; } }
        function showError(id, msg) { const e=el(id); e.innerText=msg; e.classList.remove('hidden'); setTimeout(()=>e.classList.add('hidden'),3000); }

        init();
    </script>
</body>
</html>
